name: Build Blender Android

on:
  workflow_dispatch:

jobs:
  build:
    name: Build Blender for Android
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Blender source
        uses: actions/checkout@v4
        with:
          repository: blender/blender
          submodules: true
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.10

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y git cmake ninja-build pkg-config \
            build-essential libgl1-mesa-dev libxi-dev libx11-dev \
            libxxf86vm-dev libxrandr-dev libxinerama-dev libxcursor-dev \
            libxext-dev libxfixes-dev libegl1-mesa-dev libgles2-mesa-dev \
            libepoxy-dev wget unzip openjdk-11-jdk

      - name: Download Android NDK
        run: |
          wget https://dl.google.com/android/repository/android-ndk-r25c-linux.zip
          unzip android-ndk-r25c-linux.zip
          mv android-ndk-r25c $HOME/android-ndk

      - name: Create build directory
        run: mkdir build-android && cd build-android

      - name: Configure CMake
        run: |
          cmake ../blender \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE=$HOME/android-ndk/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=android-24 \
            -DCMAKE_ANDROID_NDK=$HOME/android-ndk \
            -DCMAKE_SYSTEM_NAME=Android \
            -DWITH_PLAYER=OFF \
            -DWITH_INSTALL_PORTABLE=ON

      - name: Build APK
        run: cmake --build . --target install

      - name: Upload Blender Android APK
        uses: actions/upload-artifact@v4
        with:
          name: blender-android-apk
          path: build-android/bin/*.apk
