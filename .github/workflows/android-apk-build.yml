name: Build Blender Android APK

on:
  workflow_dispatch:

jobs:
  build:
    name: Build Blender for Android
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Blender source
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y git wget ninja-build cmake gcc g++ unzip build-essential libxi-dev libxcursor-dev libxrandr-dev libxinerama-dev libglew-dev libgl1-mesa-dev libegl1-mesa-dev libgles2-mesa-dev libglu1-mesa-dev

      - name: Download Android NDK r25c
        run: |
          wget https://dl.google.com/android/repository/android-ndk-r25c-linux.zip
          unzip -q android-ndk-r25c-linux.zip
          mv android-ndk-r25c $HOME/android-ndk

      - name: Set environment for NDK
        run: |
          echo "ANDROID_NDK=$HOME/android-ndk" >> $GITHUB_ENV

      - name: Init submodules
        run: |
          git submodule update --init --recursive

      - name: Build Android APK (ARM64)
        run: |
          make update
          make android_arm64

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: blender-android-apk
          path: build-android/bin/Blender.apk
